[15.PHP基础](https://www.yuque.com/zhuxingliangchen/yg0f92/wrq11nrgqfg28sez)[16.前后端交互](https://www.yuque.com/zhuxingliangchen/yg0f92/ghlawz51mzct331g)

## 1.Cookie原理
> 当用户访问网站时，服务器用过响应头将一个或多个cookie发送到用户的浏览器，存储在本地，并在以后的每个请求中1将其作为请求头的一部分发送给服务器
>

> 每个都有一个名称和对应的值。服务器可设置其过期时间，使其在指定时间过期。还可设置其作用域（域名和路径），以限制哪些页面可以使用该cookie访问
>

+ 当浏览器发送请求时，会将当前站点相关的cookie一起发送到服务器。服务器读取cookie并根据其中的数据来执行相关操作，例如保持用户登录状态、个性化用户体验等

![](https://cdn.nlark.com/yuque/0/2025/png/59258918/1763460511087-01e1ee39-f302-4579-b32f-8f3eb979d8e6.png)

前端的html可以用ai，重点是后端的php

```php
//登陆的前端代码 前端代码对安全的意义不大
//可直接用AI完成 以下是豆包帮忙编写的html
//HTML可在php中进行混编
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单登录页面</title>
    <style>
        /* 基础样式，保持简洁 */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        input[type="submit"] {
            width: 100%;
            padding: 12px;
            background-color: #165DFF;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        input[type="submit"]:hover {
            background-color: #0E4CD1;
        }
        .options {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 14px;
        }
        .link {
            color: #165DFF;
            text-decoration: none;
        }
        .link:hover {
            text-decoration: underline;
        }
        .error {
            color: #ff4d4f;
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #fff1f0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h1>用户登录</h1>
        
        <!-- 错误提示区域（PHP处理后可能显示错误信息） -->
        <?php if (!empty($error)): ?>
            <div class="error"><?php echo $error; ?></div>
        <?php endif; ?>

        <!-- 登录表单：action指向处理登录的PHP文件，方法用POST -->
        <form action="login.php" method="post">
            <div class="form-group">
                <label for="username">用户名/邮箱</label>
                <input type="text" id="username" name="username" required 
                       placeholder="请输入用户名或邮箱">
            </div>

            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" name="password" required 
                       placeholder="请输入密码">
            </div>

            <div class="options">
                <label>
                    <input type="checkbox" name="remember"> 记住我
                </label>
                <a href="forgot_password.php" class="link">忘记密码？</a>
            </div>

            <input type="submit" value="登录">
        </form>

        <div style="text-align: center; margin-top: 20px;">
            还没有账号？<a href="register.php" class="link">立即注册</a>
        </div>
    </div>
</body>
</html>

<?php
//登陆文件	需要查询数据库
    //先判断有没有post请求
    if($_SERVER["REQUEST_METHOD"] == "POST"){
        //接受前端传过来的数据
        $user = $_POST['username'];
        $password = $_POST['password'];
        //连接数据库
        $conn = mysqli_connect("localhost", "root", "123qqq,,,", "mysql");
        if($conn){
            $SQL = "SELECT * FROM user where User = '$user';";
            $result = mysqli_query($conn, $SQL);

            //mysqli_num_rows()函数返回结果集中行的数量 如果数据库中有对应的结果就有数据
            if(mysqli_num_rows($result) > 0){
                //设置Cookie的存在时间 1个月
                $expire = time()+60*60*24*30;
                setcookie("user", $user, $expire,'/');//向客户端发送一个cookie，名为user 绑定到$user 存活1个月 /表示档前的所有域都有效，以此提高用户的体验感
                setcookie("password", $password, $expire,'/');
                //header 跳转
                header('location:index.php');
            }
            else{
                echo '登录失败';
            }
        }
        else{
            echo '数据库连接失败';
        }
    }

?>
```

```php

<?php
//先执行逻辑判断
//判断Cookie和数字库里面存放的信息是否一致
//一致的话才能访问后台页面
//不一致的话挑战会登录页面
$conn = mysqli_connect("localhost", "root", "123qqq,,,", "mysql");
$sql = "SELECT * FROM user";
$data = mysqli_query($conn, $sql);

//比对用户cookie和数据库的数据是否一致
$isValidUser = false;
while($row = mysqli_fetch_array($data)){
    if($_COOKIE['user']==$row['User']){
        $isValidUser = true;
        break;
    }
}
if($isValidUser == false){
    header("Location: index.php");
    exit;
}//如果没有这段验证就是无授权访问漏洞
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>欢迎页面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 500px;
        }
        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 20px;
            object-fit: cover;
            border: 3px solid #eee;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        p {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .links {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .link-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background-color: #f8f9fa;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .link-item:hover {
            background-color: #e9ecef;
        }
        .link-item i {
            margin-right: 10px;
            font-size: 18px;
            color: #007bff;
        }
        .logout-btn {
            margin-top: 30px;
            padding: 10px 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
    </style>
    <!-- 引入 Font Awesome 用于图标 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
</head>
<body>
<div class="container">
    <!-- 头像 -->
    <img src="https://picsum.photos/id/64/200/200" alt="用户头像" class="avatar">

    <!-- 欢迎信息 -->
    <h1>欢迎回来，<?php echo "用户名"; ?></h1>
    <p>今天是 <?php echo date("Y年m月d日"); ?>，祝您学习愉快！</p>

    <!-- 功能链接 -->
    <div class="links">
        <a href="profile.php" class="link-item">
            <i class="fa fa-user"></i>
            <span>查看个人资料</span>
        </a>
        <a href="courses.php" class="link-item">
            <i class="fa fa-book"></i>
            <span>我的课程</span>
        </a>
        <a href="settings.php" class="link-item">
            <i class="fa fa-cog"></i>
            <span>账户设置</span>
        </a>
    </div>

    <!-- 退出登录按钮 -->
    <button class="logout-btn" onclick="location.href='logout.php'">
        <i class="fa fa-sign-out"></i> 退出登录
    </button>
</div>
</body>
</html>
```

```php
<?php
//退出文件
//清空用户的cookie信息
//跳转回登陆页面
    $expire = time()-3600;//cookie过期
    setcookie("user",'', $expire,'/');
    setcookie("password",'', $expire,'/');
    //跳转登录界面
    header('Location: cookie.php');
?>
```

以上未进行过滤，在数据库查询时可使用sql语句，例：or 1=1 进行SQL注入

`index.php`开头未进行的情况下就是未授权访问漏洞

传参是未限制传参，就是文件包含漏洞，可以直接传木马或其他

---

## 2.session原理
> 与cookie相似但有所不同
>

+ 存储位置不同：
    - Cookie存储在客户端
    - session存储在服务器端
+ 安全性不同：
    - 客户端的易被利用窃取
+ 存储容量不同：
    - cookie有限，一般为4kb
    - session理论没有上限，取决于服务器的硬件配置
+ 生命周期不同：
    - cookie是设置的过期时间
    - session是关闭浏览器就会过期
+ 访问方式不同：
    - cookie可使用JavaScript访问
    - session只能在服务器进行访问
+ 使用场景不同：
    - cookie一般用于存储小型数据
    - session一般用于存储大型数据

![](https://cdn.nlark.com/yuque/0/2025/png/59258918/1763635486694-3f9c73e2-b92a-42be-92a9-25495aa3b653.png)

session的ID会作为cookie的值存在客户端，可通过替换cookie值来调用他人session

```php
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单登录页面</title>
    <style>
        /* 基础样式，保持简洁 */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        input[type="submit"] {
            width: 100%;
            padding: 12px;
            background-color: #165DFF;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        input[type="submit"]:hover {
            background-color: #0E4CD1;
        }
        .options {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 14px;
        }
        .link {
            color: #165DFF;
            text-decoration: none;
        }
        .link:hover {
            text-decoration: underline;
        }
        .error {
            color: #ff4d4f;
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #fff1f0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div class="login-container">
    <h1>用户登录</h1>

    <!-- 错误提示区域（PHP处理后可能显示错误信息） -->
    <?php if (!empty($error)): ?>
        <div class="error"><?php echo $error; ?></div>
    <?php endif; ?>

    <!-- 登录表单：action处留空表示指向处理登录的本文件，方法用POST -->
    <form action="" method="post">
        <div class="form-group">
            <label for="username">用户名/邮箱</label>
            <input type="text" id="username" name="username" required
                   placeholder="请输入用户名或邮箱">
        </div>

        <div class="form-group">
            <label for="password">密码</label>
            <input type="password" id="password" name="password" required
                   placeholder="请输入密码">
        </div>

        <input type="submit" value="登录">
    </form>

</div>
</body>
</html>


<?php
  //登陆文件
  if($_SERVER["REQUEST_METHOD"] == "POST") {
    //导入mysql连接配置文件
    include "config.php";

    //接受前端传送的账密
    $user = $_POST['username'];
    $password = $_POST['password'];
    if ($conn) {
        $SQL = "SELECT * FROM user where username = '$user' and password = '$password';";

        $result = mysqli_query($conn, $SQL);
        if(mysqli_num_rows($result) > 0){
            //启动session会话
            session_start();

            //存储变量到session
            $_SESSION["user"] = $user;
            $_SESSION["password"] = $password;

            //跳转
            header("Location: index.php");
        }else{
            echo '账号或密码错误';
        }
    }

}
?>
```

```php
<?php
    //连接数据库
    $dbip = "localhost";
    $dbuser = "root";
    $dbpass = "123qqq,,,";
    $dbname = "demo01";
    $conn = mysqli_connect($dbip, $dbuser, $dbpass, $dbname);
```

```php
<?php
    session_start();
    //连接数据库，判断session和数据库是否相同
    include "config.php";
    $sql = "SELECT * FROM user";
    $data = mysqli_query($conn, $sql);

    $isValidUser = false;
    while($row = mysqli_fetch_array($data)){
        if($_SESSION['user']==$row['username']&&$_SESSION['password']==$row['password']){
            $isValidUser = true;
            break;
        }
    }
    if($isValidUser == false){
        header("Location: admin.php");
        exit;
    }
    ?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>欢迎页面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 500px;
        }
        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 20px;
            object-fit: cover;
            border: 3px solid #eee;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        p {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .links {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .link-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background-color: #f8f9fa;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .link-item:hover {
            background-color: #e9ecef;
        }
        .link-item i {
            margin-right: 10px;
            font-size: 18px;
            color: #007bff;
        }
        .logout-btn {
            margin-top: 30px;
            padding: 10px 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
    </style>
    <!-- 引入 Font Awesome 用于图标 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
</head>
<body>
<div class="container">

    <!-- 欢迎信息 -->
    <h1>欢迎回来，<?php echo "用户名"; ?></h1>

    <!-- 功能链接 -->
    <div class="links">
        <a href="profile.php" class="link-item">
            <i class="fa fa-user"></i>
            <span>查看个人资料</span>
        </a>
        <a href="courses.php" class="link-item">
            <i class="fa fa-book"></i>
            <span>我的课程</span>
        </a>
        <a href="settings.php" class="link-item">
            <i class="fa fa-cog"></i>
            <span>账户设置</span>
        </a>
    </div>

    <!-- 退出登录按钮 -->
    <button class="logout-btn" onclick="location.href='logout.php'">
        <i class="fa fa-sign-out"></i> 退出登录
    </button>
</div>
</body>
</html>

```

```php
<?php
    session_start();
    //销毁档期那会话中的所有数据
    session_destroy();

    //销毁会话中的所有变量
    session_unset();

    //重定向
    header("Location: admin.php");
```



---

## 3.token原理
+ 令牌（token）是在身份验证和授权过程中用于识别和验证用户身份的一种机制。
+ 一个代表用户身份信息的字符串，可以被服务器用来验证用户的访问权限
+ 令牌可以是随机生成的字符串，具有足够的复杂性，以确保唯一性和安全性。可包含有关用户身份验证和授权的信息，例如用户ID、权限、过期时间等
+ 在身份验证流程中，当用户提供有效的用户名和密码进行登录时，服务器会生成一个令牌并将其返回给客户端。客户端通常会将令牌存储在本地，例如在浏览器的cookie中或本地存储

```php
<?php
//登录文件

    //开启session会话
    session_start();

    //生成随机值  随机唯一即可
    $token = bin2hex(random_bytes(16));//生成16位的随机数
    //绑定
    $_SESSION['token'] = $token;
    setcookie("token", $token, time() + 3600,'/');
?>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单登录页面</title>
    <style>
        /* 基础样式，保持简洁 */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        input[type="submit"] {
            width: 100%;
            padding: 12px;
            background-color: #165DFF;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        input[type="submit"]:hover {
            background-color: #0E4CD1;
        }
        .options {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 14px;
        }
        .link {
            color: #165DFF;
            text-decoration: none;
        }
        .link:hover {
            text-decoration: underline;
        }
        .error {
            color: #ff4d4f;
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #fff1f0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div class="login-container">
    <h1>用户登录</h1>

    <!-- 错误提示区域（PHP处理后可能显示错误信息） -->
    <?php if (!empty($error)): ?>
        <div class="error"><?php echo $error; ?></div>
    <?php endif; ?>

    <!-- 登录表单：action指向处理登录的PHP文件，方法用POST -->
    <form action="token——check.php" method="post">
        <div class="form-group">
            <label for="username">用户名/邮箱</label>
            <input type="text" id="username" name="username" required
                   placeholder="请输入用户名或邮箱">
        </div>

        <div class="form-group">
            <label for="password">密码</label>
            <input type="password" id="password" name="password" required
                   placeholder="请输入密码">
            <input type="hidden" name="token" value="<?php echo $token; ?>"><!--隐藏事件类型-->
        </div>

        <input type="submit" value="登录">
    </form>

</div>
</body>
</html>

```

```php
<?php
//token校验
    //开启session会话
    session_start();

    //从客户端的cookie中提取token与session进行比对
    $token = $_COOKIE["token"] ?? '';//3目操作 如果有传参过来就用传参值，没有传参就用空值
    if($_SESSION['token']!=$token){
        echo '没有权限/地址非法，疑是攻击行为';
        //判断以后，要更新token值
        $_SESSION['token'] = bin2hex(random_bytes(16));
    }else{
        //更新服务端token
        $_SESSION['token'] = bin2hex(random_bytes(16));
        //判断账号和密码是否相等正确
        //与之前的一样去验证账号密码

    }
```

